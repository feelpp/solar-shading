<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 3 - Becnhmarking and Performance Measurement :: Solar Shading</title>
    <link rel="canonical" href="https://feelpp.github.io/solar-shading/solar-shading/internships/devora/chap3.html">
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>

<script src="../../../_/js/vendor/tabs-block-extension.js"></script>
<script src="../../../_/js/vendor/tabs-block-behavior.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      RR: "{\\mathbb R}",
      NN: "{\\mathbb N}",
      Nso: "{N_{\\mathrm{so}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      Nno: "{N_{\\mathrm{no}}}",
      Ne: "{N_{\\mathrm{e}}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      calTh: "{\\mathcal{T}_h}",
      Ck: ["{\\mathcal{C}^{#1}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Qch: ["{Q^{#1}_{c,h}}",1],
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      poly: ["{\\mathbb{#1}}",1],
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      geo: "{\\mathrm{geo}}",
      card: ["{\\operatorname{card}(#1)}",1],
      dim: ["{\\operatorname{dim}(#1)}",1],
      opdim: "{\\operatorname{dim}}",
      card: ["{\\operatorname{card}(#1)}",1],
      poly: ["{\\mathbb{#1}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      set: ["{\\left\\{#1\\right\\}}",1],
      diam: "{\\operatorname{diam}}",
      jump: ["{[\\![ #1 ]\\!]}",1],
      Next: "{\\mathrm{n}}",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      tr: "{\\operatorname{tr}}",
      Id: "{\\mathcal{I}}",
      disp: ["{\\mathbf{#1}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      domain: "{\\Omega}",
      prect: ["{\\left\\(#1\\right\\)}",1],
      ds: "",
      bold: ["{\\bf #1}",1],
      p: "{\\mathrm{p}}",
      q:"{\\mathbf{q}}",
      n:"{\\mathbf{n}}",
      T:"{\\mathcal{T}}",
      F:"{\\mathcal{F}}",
      P:"{\\mathcal{P}}",
      v:"{\\mathbf{v}}"
  },
  extensions: ["mhchem.js"] }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML'>
</script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->
<script>var uiRootPath = '../../../_'</script>

  </head>
  <body class="article">
<header class="header">
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark navbar-template-project"
        style="border-top: 4px solid #9E9E9E">
        <div class="navbar-brand">
            <div class="navbar-item feelpp-logo">
                <a href="https://feelpp.github.io/solar-shading">Solar Shading</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item">
                    <a href="https://docs.feelpp.org/">Documentation Reference</a>
                </div>
                <div class="navbar-item has-dropdown is-hoverable download-item">
                    <div class="navbar-item"><a href="https://docs.feelpp.org/user/latest/install/index.html"
                            class="download-btn">Get Feel++</a></div>
                </div>
                <div class="navbar-item">
                    <a class="navbar-brand" href="https://www.cemosis.fr">
                        <img class="cemosis-logo" src="../../../_/img/cemosis-logo.svg" alt="Cemosis logo" />
                    </a>
                </div>
            </div>
        </div>
    </nav>
</header><div class="body">
<a href="#" class="menu-expand-toggle"></a>
<div class="nav-container" data-component="solar-shading" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Feel++ Solar Shading</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Shading Masks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../shadingmask.html">Theory and Implementation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../data/format.html">Data format and visualisation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../data/management.html">Data Management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Environment</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cmake.adoc">cmake environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#antora.adoc">antora environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#vscode.adoc">vscode integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#githubactions.adoc">Github Actions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../rename.html">Renaming the project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#jupyter.adoc">Jupyter Notebook</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Feel++ Solar Shading</span>
    <span class="version"></span>
  </div>
  <ul class="components">
      <li class="component is-current">
        <a class="title" href="../../index.html">Feel++ Solar Shading</a>
      </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
  <button class="nav-toggle"></button>
    <a href="../../index.html" class="home-link"></a>
  <nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Feel++ Solar Shading</a></li>
    <li><a href="chap3.html">Chapter 3 - Becnhmarking and Performance Measurement</a></li>
  </ul>
</nav>

  
    <div class="edit-this-page"><a href="https://github.com/feelpp/solar-shading/edit/master/docs/modules/internships/pages/devora/chap3.adoc">Edit this Page</a></div>
  
  <div class="page-downloads">
  <span class="label">Download as</span>
  <ul class="download-options">
    <li>
      <a onclick="print(this)" href="#" data-toggle="tooltip" data-placement="left" title="Print to PDF"
         class="pdf-download">
        <img class="pdf-file-icon icon" src="../../../_/img/pdf.svg"/> .pdf
      </a>
    </li>
  </ul>
</div>
</div>

  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Chapter 3 - Becnhmarking and Performance Measurement</h1>
<div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_reframe_benchmarking">1. Reframe Benchmarking</a>
<ul class="sectlevel2">
<li><a href="#_utility">1.1. Utility</a></li>
</ul>
</li>
<li><a href="#_random_number_generators">2. Random Number Generators</a>
<ul class="sectlevel2">
<li><a href="#_rng_speed_benchmark">2.1. RNG Speed Benchmark</a></li>
<li><a href="#_rng_quality_benchmark_and_influence_on_the_monte_carlo_integration">2.2. RNG Quality Benchmark and influence on the Monte Carlo Integration</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reframe_benchmarking"><a class="anchor" href="#_reframe_benchmarking"></a>1. Reframe Benchmarking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Reframe is a framework designed to abstract the complexities behind running regression tests on different high-performance computing (HPC) systems, hence facilitating the validation of software across varying systems. The framework aims to decouple runtime-specific behavior from the logic of individual tests, allowing for a single test to run seamlessly across different environments. Written in Python, it allows users to express their testing logic in Python, and utilizes decorators and hooks to provide extensibility and adaptability.</p>
</div>
<div class="sect2">
<h3 id="_utility"><a class="anchor" href="#_utility"></a>1.1. Utility</h3>
<div class="paragraph">
<p>Reframe offers several advantages over shell scripts and other testing frameworks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Portability: One of the primary reasons for using Reframe is its ability to run the same test across different HPC platforms without modification.</p>
</li>
<li>
<p>Flexibility: Users can write their own tests in Python, taking advantage of the expressiveness and extensibility of the language.</p>
</li>
<li>
<p>Extensibility: Through hooks and decorators, Reframe can be extended and adapted to support a wide range of testing scenarios.</p>
</li>
<li>
<p>Scalability: It supports running tests in parallel, making it efficient for large-scale testing scenarios.</p>
</li>
<li>
<p>Monitoring: With built-in performance tracking, Reframe makes it simple to monitor the performance of software components over time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The given Python code is an example of how Reframe can be utilized to benchmark different random number generators using various compilation flags. The benchmarks are executed across five different C++ files representing different RNGs. Using parameterization, each RNG is compiled and run with various optimization flags. Post-execution, the runtime of each RNG with the respective flags is extracted and the best runtime for each RNG is reported. This systematic approach of using Reframe makes it easier to discern the performance implications of different compiler flags on RNGs, facilitating optimal compiler flag selection for desired performance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">flags = [
    "-O1", "-O2", "-O3", "-Ofast",
    "-O1 -march=native", "-O2 -march=native", "-O3 -march=native", "-Ofast -march=native",
    "-O1 -march=native -funroll-loops", "-O2 -march=native -funroll-loops", "-O3 -march=native -funroll-loops", "-Ofast -march=native -funroll-loops",
    "-O1 -march=native -fdisable-tree-cunrolli", "-O2 -march=native -fdisable-tree-cunrolli", "-O3 -march=native -fdisable-tree-cunrolli", "-Ofast -march=native -fdisable-tree-cunrolli"
]

cpp_files = [
    'eigenrand_int.cpp',
    'pcg_int.cpp',
    'xoshiro_int.cpp',
    'mersenne_twister_int.cpp',
    'std_int.cpp'
]

@rfm.simple_test
class RNGBenchmarkTest(rfm.RegressionTest):
    best_times = {}
    valid_systems = ['*']
    valid_prog_environs = ['gcc']
    build_system = 'SingleSource'
    sourcesdir = 'src/reframe'
    flags = parameter(flags)
    cpp_file = parameter(cpp_files)

    def __init__(self, flags=None, cpp_file=None):
        super().__init__()

        # Default values for flags and cpp_file if not provided
        self.flags = flags if flags else '-O3 -march=native'
        self.cpp_file = cpp_file if cpp_file else 'std_int.cpp'

        self.valid_systems = ['*']
        self.valid_prog_environs = ['*']
        self.build_system = 'SingleSource'
        self.build_system.cxx = 'g++'
        self.build_system.cxxflags = [self.flags]
        self.sourcepath = self.cpp_file
        # self.sanity_patterns = sn.assert_found(r'PASSED', self.stdout)

        self.tags = {'production'}

    @property
    def name(self):
        return f'{self.__class__.__name__}_flags_{self.flags.replace(" ", "_")}_{os.path.splitext(self.cpp_file)[0]}'

    @run_before('run')
    def set_prerun_cmds(self):
        if self.cpp_file == 'eigenrand_int.cpp':
            build_cmd = f'g++ -Wno-enum-compare {self.flags} -I{os.path.abspath("../extlibs/EigenRand")} -o {os.path.splitext(self.cpp_file)[0]} {self.cpp_file}'
            self.prerun_cmds = [
                f'echo "Building {self.cpp_file} with {self.flags}"',
                'echo "Executing build command: ' + build_cmd + '"',
                build_cmd,
                f'./{os.path.splitext(self.cpp_file)[0]}'
            ]
        if self.cpp_file == 'pcg_int.cpp':
            build_cmd = f'g++ -Wno-enum-compare {self.flags} -I{os.path.abspath("../extlibs/pcg-cpp/include")} -o {os.path.splitext(self.cpp_file)[0]} {self.cpp_file}'
            self.prerun_cmds = [
                f'echo "Building {self.cpp_file} with {self.flags}"',
                'echo "Executing build command: ' + build_cmd + '"',
                build_cmd,
                f'./{os.path.splitext(self.cpp_file)[0]}'
            ]
        if self.cpp_file == 'xoshiro_int.cpp':
            build_cmd = f'g++ -Wno-enum-compare {self.flags} -I{os.path.abspath("../extlibs/Xoshiro-cpp/include")} -o {os.path.splitext(self.cpp_file)[0]} {self.cpp_file}'
            self.prerun_cmds = [
                f'echo "Building {self.cpp_file} with {self.flags}"',
                'echo "Executing build command: ' + build_cmd + '"',
                build_cmd,
                f'./{os.path.splitext(self.cpp_file)[0]}'
            ]
        if self.cpp_file == 'mersenne_twister_int.cpp':
            build_cmd = f'g++ -Wno-enum-compare {self.flags} -o {os.path.splitext(self.cpp_file)[0]} {self.cpp_file}'
            self.prerun_cmds = [
                f'echo "Building {self.cpp_file} with {self.flags}"',
                'echo "Executing build command: ' + build_cmd + '"',
                build_cmd,
                f'./{os.path.splitext(self.cpp_file)[0]}'
            ]
        if self.cpp_file == 'std_int.cpp':
            build_cmd = f'g++ -Wno-enum-compare {self.flags} -o {os.path.splitext(self.cpp_file)[0]} {self.cpp_file}'
            self.prerun_cmds = [
                f'echo "Building {self.cpp_file} with {self.flags}"',
                build_cmd,
                f'./{os.path.splitext(self.cpp_file)[0]}'
            ]

    @performance_function('μs')
    def extract_runtime(self):
        regex_map = {
            'eigenrand_int.cpp': 'EigenRand,(\S+)',
            'pcg_int.cpp': 'pcg-cpp,(\S+)',
            'xoshiro_int.cpp': 'xoshiro-cpp,(\S+)',
            'mersenne_twister_int.cpp': 'MersenneTwister,(\S+)',
            'std_int.cpp': 'std::uniform_distribution,(\S+)'
        }
        perf = sn.extractsingle(regex_map[self.cpp_file], self.stdout, 1, float)
        if self.cpp_file not in RNGBenchmarkTest.best_times or RNGBenchmarkTest.best_times[self.cpp_file][0] &gt; perf:
            RNGBenchmarkTest.best_times[self.cpp_file] = (perf, self.flags)  # update if this time is the best
        return perf


    @sanity_function
    def assert_output(self):
        regex_map = {
            'eigenrand_int.cpp': 'EigenRand,(\S+)',
            'pcg_int.cpp': 'pcg-cpp,(\S+)',
            'xoshiro_int.cpp': 'xoshiro-cpp,(\S+)',
            'mersenne_twister_int.cpp': 'MersenneTwister,(\S+)',
            'std_int.cpp': 'std::uniform_distribution,(\S+)'
        }
        return sn.assert_found(regex_map[self.cpp_file], self.stdout)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_random_number_generators"><a class="anchor" href="#_random_number_generators"></a>2. Random Number Generators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When dealing with solar shading masks computation, it&#8217;s strongly recommended to use the Monte-Carlo technic, namely during the ray-tracing part of the algorithm enabling one to backtrace the paths to find shaded locations due to the environment. But this comes at a cost, since it&#8217;s mathematically accurate only when tracing multiple rays in random directions, being the foundation of this method.</p>
</div>
<div class="paragraph">
<p>Since this project is at district or even city scale, the use of a fast Random Number Generators (RNG) is necessary. Despite numerous benchmarks already been done, we decided to compare some of the fastest open-source libraries, all heavily relying on Vectorization, multi-threading or multicore processing, and performance-targeted compiling flags (such as <code>-03</code> to <code>-0fast</code>). Since Intel processors have specific instructions and extensions (such as Streaming SIMD Extensions, SSE2) and Advanced Vector Extensions (AVX), the MKL advanced Mathematics library naturally benefits of efficient vectorized operations.</p>
</div>
<div class="sect2">
<h3 id="_rng_speed_benchmark"><a class="anchor" href="#_rng_speed_benchmark"></a>2.1. RNG Speed Benchmark</h3>
<div class="sect3">
<h4 id="_explicit_in_app_benchmarking"><a class="anchor" href="#_explicit_in_app_benchmarking"></a>2.1.1. Explicit In-App Benchmarking</h4>
<div class="paragraph">
<p>We have to adopt rigorous coding methods, proving and explaining our reasoning behind every choice made during the internship. In order to settle on a specific method, benchmarks have to be performed. Since many different random number generators have to be tested, a first automation of the benchmarking process was done using a bash script, which can be found in the <code>benchmarking</code> folder of the repository. This script compiles and executes the code for each RNG, and outputs the results in a <code>.csv</code> file as well as in the terminal, in the form of a table, stating the best execution times for each method, and the flags used during compilation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">set -e

flags=(
    "-Ofast"
    "-O3"
    "-O2"
    "-Ofast -funroll-loops"
    "-O3 -funroll-loops"
    "-O2 -funroll-loops"
    "-Ofast -funroll-loops -funsafe-math-optimizations"
    "-Ofast -march=znver2"
    "-Ofast -ftlo"
)

# Obtain the path to the script
SCRIPT_PATH="$(dirname "$(realpath "$0")")"
# Obtain the root directory path by removing /src from the script path
ROOT_PATH="${SCRIPT_PATH%/src}"

cd "$ROOT_PATH/build/default/src"

echo "Select the config file: "
echo "1. exampleShadingMask"
echo "2. 19buildingsStrasbourg"
read -p "Enter the number (1 or 2): " NUMBER1

case "$NUMBER1" in
  1)
    CONFIG_FILE="$ROOT_PATH/src/cases/exampleShadingMask/exampleShadingMask.cfg"
    ;;
  2)
    CONFIG_FILE="$ROOT_PATH/src/cases/19buildingsStrasbourg/19buildingsStrasbourg.cfg"
    ;;
  *)
    echo "Invalid input! Enter 1 or 2."
    exit 1
esac

declare -A best_times_map
declare -A best_flags_map

for method in "RNG STD" "RNG XOSHIRO" "RNG PCG" "RNG MIX" "RNG EIGEN" "RNG EIGEN CAST" "RNG EIGEN VEC"; do
    best_times_map["$method"]=1000
    best_flags_map["$method"]=""
done

for ((NUMBER=1; NUMBER&lt;${#flags[@]}+1; NUMBER++))
do
    EXECUTABLE="./example_ShadingMasks_comparison${NUMBER}"

    echo "Running the command : $EXECUTABLE --config-file $CONFIG_FILE"
    output=$( $EXECUTABLE --config-file $CONFIG_FILE )

    for method in "${!best_times_map[@]}"; do
        execution_time=$(echo "$output" | grep -oP "(?&lt;=Elapsed time for shading mask computation with $method:)[0-9.]+")

        if (( $(echo "$execution_time &lt; ${best_times_map[$method]}" | bc -l) ))
        then
            best_times_map["$method"]=$execution_time
            best_flags_map["$method"]=${flags[$NUMBER]}
        fi
    done
done

# Display the summary
printf "\n\n"
printf "==============================================================================\n"
printf "%-25s %-10s %s\n" "METHOD" "TIME (seconds)" "FLAGS"
printf "==============================================================================\n"
for method in "${!best_times_map[@]}"; do
    printf "%-25s %-15s %s\n" "$method:" "${best_times_map[$method]} s" "'${best_flags_map[$method]}'"
done
printf "==============================================================================\n"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is one of its outputs, showing an improvement of 8.63% in execution time when using the <code>-Ofast -funroll-loop</code> flags on the Xoshiro method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">==============================================================================
METHOD                    TIME (seconds) FLAGS
==============================================================================
RNG STD:                  9.389095158 s   '-O2'
RNG EIGEN:                9.121100925 s   '-O2'
RNG EIGEN CAST:           9.19422145 s    '-O2 -funroll-loops'
RNG PCG:                  9.382495989 s   '-Ofast -funroll-loops'
RNG XOSHIRO:              8.578198413 s   '-Ofast -funroll-loops'
RNG EIGEN VEC:            9.554856035 s   '-Ofast -funroll-loops'
RNG MIX:                  9.412993456 s   '-O2'
==============================================================================</code></pre>
</div>
</div>
<div class="paragraph">
<p>But such performance improvements are inconsistent, even for a single method and flag since some RNGs, or the tasks using them (like the state-based traversal algorithm), might have non-deterministic paths. This means that even with the same seed, the exact sequence of operations might differ slightly in different runs, leading to performance variations.</p>
</div>
<div class="paragraph">
<p>These benchmarks can be launched after launching these commands from the root of the repo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cmake --preset default
cmake --build build/default
./src/run_all.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>If one intents to benchmark all methods on a specific set of flags, the <code>run_examples.sh</code> script can be used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cmake --preset default
cmake --build build/default
./src/run_examples.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>And choosing the flags and test cases using the terminal.</p>
</div>
</div>
<div class="sect3">
<h4 id="_available_methods"><a class="anchor" href="#_available_methods"></a>2.1.2. Available Methods</h4>
<div class="paragraph">
<p>As said, numerous methods are open-source and available to use, built upon different fundamentals. The Xoshiro-Cpp is a lightweight, high-performance random number generator known for its speed and low memory consumption. The Mersenne Twister, on the other hand, is widely used for its long period and good statistical properties. std::random provides a standardized interface for random number generation in C++, offering various generators including Mersenne Twister. Eigen::Rand is a random number generator headers library strongly relying on Eigen&#8217;s vectorization capabilities, useful for generating random matrices in numerical computations. Intel MKL offers high-performance, vectorized random number generation routines optimized for scientific and numerical computing while <code>pcg-cpp</code> is a Permuted Congruential Generator implementation balancing speed and randomness for simulations and gaming.</p>
</div>
<div class="paragraph">
<p>The tested libraries are:
- EigenRand: a random number generator headers library strongly relying on Eigen&#8217;s vectorization capabilities, useful for generating random matrices in numerical computations (especially random vectors in our case).
- EigenRand&#8217;s real generator casted to int: the same as above, but casting the generated real numbers to integers in order to gain speed.
- PCG-CPP: a Permuted Congruential Generator implementation balancing speed and randomness for simulations.
- Xoshiro-Cpp: a lightweight, high-performance random number generator reknown for its speed and low memory consumption.
- Mersenne Twister: a widely used random number generator for its long period and good statistical properties, available in the standard library.
- Intel MKL: a high-performance, vectorized random number generation routines optimized for scientific and numerical computing.
- std::random: a standardized interface for random number generation in C++, offering various generators including Mersenne Twister.</p>
</div>
<div class="paragraph">
<p>Below you can see a first execution time comparison, using the <code>std::chrono</code> library to measure the time taken by each method to generate 1000000 random numbers. The code was compiled using different usual flags, such as <code>-O3</code>, <code>-Ofast</code>, <code>-O2</code> and <code>-O1</code>.</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="ROOT::flagcomparison.png" alt="Barplot comparing execution time"></span>[600]</p>
</div>
<div class="paragraph">
<p>We can observe that all of the presented methods, except for Eigen&#8217;s one, are outperforming the standard library.</p>
</div>
</div>
<div class="sect3">
<h4 id="_different_flags"><a class="anchor" href="#_different_flags"></a>2.1.3. Different Flags</h4>
<div class="paragraph">
<p>Since Intel&#8217;s oneAPI MKL library is by far the highest speed RNG, we benchmarked it using more specific flags, such as <code>march=native</code> in order to enable all the processor&#8217;s extensions, and switching between <code>sequential</code> and <code>threaded</code> modes. The results are shown below:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="ROOT::intel.png" alt="intel" width="600"></span></p>
</div>
<div class="paragraph">
<p>And below the second speed test done on Gaia, a system composeed of 192 AMD EPYC 7552 48-Core Processors. During this second benchmark, we cycled through most of the different compilation flags combinations, and the results are shown below:</p>
</div>
<div class="paragraph">
<p><span class="image unresolved"><img src="ROOT::AMDspeed.png" alt="600"></span></p>
</div>
<div class="paragraph">
<p><a href="https://caiorss.github.io/C-Cpp-Notes/compiler-flags-options.html">Here</a> is a website describing the use-cases of each compilation flag and what they do.</p>
</div>
<div class="paragraph">
<p>The <code>-Ofast</code> and <code>-O3</code> flags enable the following optimizations for the user:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Loop unrolling: This optimization involves repeating the body of a loop multiple times, which reduces loop overhead and enables better parallelism.</p>
</li>
<li>
<p>Code redundancy elimination: The compiler detects portions of code that are needlessly repeated and replaces them with reused references, reducing the amount of executed code.</p>
</li>
<li>
<p>Vectorization: Loops are transformed to use SIMD (Single Instruction, Multiple Data) instructions to perform simultaneous operations on multiple data elements. This effectively exploits the parallel computing capabilities of modern processors.</p>
</li>
<li>
<p>Loop fusion: Independent loops are merged into a single loop, reducing overhead and improving performance by reducing the number of iterations.</p>
</li>
<li>
<p>Function inlining: Function calls are replaced with the body of the function itself, avoiding the overhead of function calls.
Unused variable elimination: Variables that are not used in the code are detected and removed, reducing memory consumption.</p>
</li>
<li>
<p>Arithmetic operation optimization: The compiler can perform mathematical transformations to simplify expressions and reduce the number of necessary operations.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rng_quality_benchmark_and_influence_on_the_monte_carlo_integration"><a class="anchor" href="#_rng_quality_benchmark_and_influence_on_the_monte_carlo_integration"></a>2.2. RNG Quality Benchmark and influence on the Monte Carlo Integration</h3>
<div class="paragraph">
<p>Monte Carlo integration, when applied to the computation of solar shading masks, leverages random sampling to model intricate interactions of light—its scattering, reflection, and absorption across various surfaces. The random number generator (RNG) underpinning this process is of paramount importance.</p>
</div>
<div class="paragraph">
<p>Firstly, the convergence rate and accuracy of a Monte Carlo method are intimately tied to the quality of its random samples. An RNG of superior quality will ensure a sequence that&#8217;s uniformly distributed across the integration domain, which in turn guarantees swifter and more precise estimates. On the flip side, an RNG that&#8217;s lacking might inadvertently inject patterns or biases into the sequence. Such biases can warp the computed shading masks, veering the results away from realism and accuracy. In fact, we can observe how the estimation of the error in the Monte Carlo method is directly proportional to the variance of the random variable (some information found on <a href="https://en.wikipedia.org/wiki/Monte_Carlo_integration">Wikipedia</a> and combined with <a href="https://www.f-legrand.fr/scidoc/docmml/numerique/montecarlo/integrales/integrales.html">this course</a>):</p>
</div>
<div class="stemblock">
<div class="content">
\[Var(f) \cong \sigma^2 = \frac{1}{N-1} \sum_{i=1}^{N} (f(x_i) - \mu)^2\]
</div>
</div>
<div class="paragraph">
<p>where <code>f</code> is the function being integrated, <code>x_i</code> is the random sample, <code>N</code> is the number of samples, and <code>mu</code> is the mean of the function. But since:</p>
</div>
<div class="stemblock">
<div class="content">
\[I \approx Q_N \approx \frac{1}{N} \sum_{i=1}^{N} \frac{f(x_i)}{p(x_i)}\]
</div>
</div>
<div class="paragraph">
<p>where <code>I</code> is the integral, <code>Q_N</code> is the Monte Carlo estimation, and <code>p(x_i)</code> is the probability density function of the random variable <code>x_i</code>, we can deduce that:</p>
</div>
<div class="stemblock">
<div class="content">
\[Var(Q_N) = \frac{V^2}{N^2} \sum_{i=1}^{N} Var(f) = V^2 \frac{Var(f)}{N} = V^2 \frac{\sigma^2_N}{N}\]
</div>
</div>
<div class="paragraph">
<p>We observe that the variance does not need any normalization, as the chosen probability density function <code>p(x_i)</code> is uniform. Finally, if the sequence \(\sigma^2_i\) is bounded, the variance decreases asymptomatically as the number of samples increases:</p>
</div>
<div class="stemblock">
<div class="content">
\[\lim_{N \to \infty} \sqrt{Var(Q_N)} = \lim_{N \to \infty} V \frac{\sigma_N}{\sqrt{N}} \to 0\]
</div>
</div>
<div class="paragraph">
<p>Moreover, the variance of the Monte Carlo estimation, which dictates the required sample size for a particular accuracy level, is also influenced by the RNG. An RNG that fosters uniform distribution curtails variance and amplifies the method&#8217;s efficiency. Yet, this isn&#8217;t just about uniformity. It&#8217;s crucial that the random numbers be independent of one another. Any correlation between the numbers can introduce errors, and in the realm of light transport simulations, correlated random paths might birth noticeable artifacts in the output.</p>
</div>
<div class="paragraph">
<p>Reproducibility is another facet where the RNG shines. There might be instances where the exact replication of a prior Monte Carlo outcome is desired. In such cases, the ability to seed an RNG ensures that we can reproduce the same sequence of numbers, and consequently, the same results. Furthermore, as solar shading computations often dive into the realm of vast numbers—potentially billions of samples in complex settings—an RNG of merit must be adept at churning out a vast array without falling into repetitive loops or discernible patterns.</p>
</div>
<div class="paragraph">
<p>Lastly, in an age where parallel processing is commonplace, it&#8217;s indispensable for the RNG to be parallel-friendly. As multiple threads work in tandem, the RNG should be competent enough to offer each thread its unique, non-overlapping sequence, ensuring consistency and preventing any cross-correlation.</p>
</div>
<div class="paragraph">
<p>Each random number generator&#8217;s quality can be benchmarked using their repositories, also working with the submodules available in the <code>feelpp/solar-shading</code> repository.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer" style="border-top: 2px solid #e9e9e9; background-color: #fafafa; padding-bottom: 2em; padding-top: 2em;">
    <div class="container" style="display: flex; flex-direction: column; align-items: center; gap: 0.5em;">
        <div>
            <a href="https://www.cemosis.fr">
                <img src="../../../_/img/cemosis-logo.svg" alt="Cemosis logo" height="50">
            </a>
        </div>
        <span style="font-size: 0.8rem; color: #9e9e9e">© 2023 <a href="https://www.cemosis.fr" style="text-decoration: underline;">Cemosis</a>, Université de Strasbourg</span>
    </div>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>


<script async src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>


<script type="text/javascript">
function toggleFullScreen() {
   var doc = window.document;
   var docEl = doc.documentElement;

   var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
   var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

   if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
       requestFullScreen.call(docEl);
   }
   else {
       cancelFullScreen.call(doc);
   }
}
</script>
  </body>
</html>
